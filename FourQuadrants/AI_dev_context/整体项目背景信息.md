# 4Quadrants (FourQuadrants) 项目架构与开发手册

## 1. 项目基本信息
- **项目名称**: FourQuadrants (由 4Quadrants 修正，避免代码引用冲突)
- **开发者**: 唐颢宸 (Fulu)
- **目标**: 基于四象限法则的 AI 增强型 Todo List
- **核心技术栈**: SwiftUI, SwiftData, ActivityKit, WidgetKit, Swift ML (VecturaKit), watchOS

---

## 2. 工程架构 (Multi-Target Structure)
项目采用标准的 `.xcodeproj` 格式，包含以下三个核心 Target，通过 **App Groups** 实现数据互通。

| Target 名称 | 平台 | 核心职责 |
| :--- | :--- | :--- |
| **FourQuadrants** | iOS/iPadOS | 主 App 逻辑、向量数据库计算、API 调用、后台保活配置。 |
| **FourQuadrantsWidget** | iOS (Ext) | 灵动岛 (Live Activities) 渲染、主屏幕/锁屏小组件。 |
| **FourQuadrantsWatch** | watchOS | 腕上任务快速查看与状态同步。 |

---

## 3. 数据层设计 (Data & AI)

### 3.1 基础持久化 (SwiftData)
- 使用 **SwiftData** 管理任务模型（TaskModel）。
- 勾选 **CloudKit** 支持，实现 iPhone、iPad、Apple Watch 之间的无感数据同步。

### 3.2 向量数据库 (Swift ML / Local Vector DB)
- **主要用途**：**每日任务智能关联** - 创建每日计划时自动推荐 TaskList 中的相似任务
  - 用户输入 "写数学作业" → 自动推荐 "maths p36-38"
  - 完成每日任务 → 同步完成关联的 TaskList 任务
- **其他潜在用途**：
  - 语义化搜索：自然语言匹配相似任务（优先级较低，见 UserDevDoc.md）
  - 任务智能分类：辅助判断任务所属象限
  - 优先级推荐：基于任务内容推荐优先级
- **技术选型**：
  - **Embedding**: `NLEmbedding.sentenceEmbedding(for: .simplifiedChinese)` - iOS 13.0+
  - **存储**: 向量字段 `embeddingData: Data?` 直接存入 SwiftData
  - **计算**: `Accelerate (vDSP)` 框架计算余弦相似度
- **存储方案**: 向量数据存储在 SwiftData 的 `QuadrantTask.embeddingData` 字段中，确保主 App 和小组件都能访问
- **性能优化**: 
  - 复杂的 Embedding 计算在主 App 后台运行（`Task.detached`）
  - 小组件仅读取预计算的结果
  - 使用 vDSP SIMD 指令集，1万条向量比较 < 10ms

---

## 4. 关键配置清单 (Capabilities)

### 4.1 App Groups (地下数据通道)
- **Group ID**: `group.com.fulu.FourQuadrants`
- **应用场景**: 让 `FourQuadrantsWidget` 能够访问主 App 存储在 `UserDefaults(suiteName:)` 或共享文件夹下的任务数据。

### 4.2 Background Modes (后台保活)
- **Background Fetch**: 定期唤醒抓取最新 API 数据。
- **Background Processing**: 运行重型的向量数据库索引维护任务。
- **Remote Notifications**: 接收云端推送。

### 4.3 Info.plist 权限
- **灵动岛支持**: 必须添加 `NSSupportsLiveActivities = YES`。

---

## 5. 迁移与开发细节

### 5.1 从 .swiftpm 迁移步骤
1. **代码搬运**: 将源文件拖入新项目，勾选 **Target Membership**。
2. **入口对齐**: 在 `FourQuadrantsApp.swift` 中将 `ContentView()` 替换为原来的 `MainView()`。
3. **依赖重装**: 在 `Package Dependencies` 中重新添加原项目使用的第三方库。

### 5.2 灵动岛 (Live Activities) 开发逻辑
- 使用 `ActivityAttributes` 定义数据结构。
- 通过 `Activity.request(attributes:contentState:)` 在主 App 启动。
- 在 `FourQuadrantsWidget` 中通过 `ActivityConfiguration` 编写 UI。

---

## 6. 项目文件结构 (2026-02-08 更新)

```
FourQuadrants/
├── FourQuadrantsApp.swift      # App 入口
├── MainView.swift              # 主视图（TabView 容器）
│
├── Models/                     # 数据模型
│   ├── QuadrantTask.swift      # 四象限任务模型 (@Model)
│   ├── DailyTask.swift         # 每日任务模型 (@Model)
│   ├── TaskCategory.swift      # 任务分类枚举
│   └── LiveActivityAttributes.swift  # 灵动岛数据结构
│
├── Services/                   # 业务逻辑/服务层
│   ├── AppLifecycleManager.swift   # ⭐ App 生命周期管理（版本检测、Schema 迁移）
│   ├── LiveActivityManager.swift   # 灵动岛管理器
│   ├── TaskManager.swift           # 任务管理器
│   ├── SyncService.swift           # 同步服务
│   └── MSALConfig.swift            # Microsoft 登录配置
│
└── Views/                      # UI 视图
    ├── Components/             # 可复用组件
    ├── Daily/                  # 每日视图
    ├── Settings/               # 设置
    ├── Styles/                 # 样式
    └── ...                     # 其他视图
```

---

## 7. App 升级与数据迁移

### 7.1 AppLifecycleManager - 升级管理器

**位置**: `Services/AppLifecycleManager.swift`

**职责**:
- 版本检测（新安装/升级/同版本）
- SwiftData Schema 迁移
- What's New 提示控制

**关键配置**:
```swift
// 当修改 @Model 结构时，递增此版本号
static let currentSchemaVersion = 1
```

### 7.2 Schema 迁移流程

1. **SwiftData 自动处理** (无需手动迁移):
   - 添加可选字段 (`var newField: String?`)
   - 添加带默认值的字段 (`var newField: String = ""`)
   - 删除字段

2. **需要手动迁移的情况**:
   - 字段重命名
   - 字段类型变更
   - 需要业务逻辑的数据转换

3. **迁移步骤**:
   ```swift
   // 1. 递增版本号
   static let currentSchemaVersion = 2
   
   // 2. 添加迁移函数
   private func migrateSchemaToV2(modelContainer: ModelContainer) { ... }
   
   // 3. 在迁移链中调用
   if oldVersion < 2 { migrateSchemaToV2(...) }
   ```

---

## 8. 长期展望与避坑
- **命名规范**: 遵循 `com.fulu.FourQuadrants` 三段式反向域名。
- **跨端适配**: 使用 `NavigationSplitView` 同时适配 iPhone 的单列和 iPad 的侧边栏。
- **Apple Watch**: 核心逻辑共用，UI 使用专门为手表优化的小组件模式。
- **文件组织**: Models、Services、Views 三大目录，新增文件必须放入对应目录。